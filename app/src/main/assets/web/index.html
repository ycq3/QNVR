<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QNVR 预览与配置</title>
  <style>
    body { font-family: system-ui; padding: 12px; }
    img { width: 100%; max-width: 640px; background: #000; }
    .row { margin: 8px 0; }
    label { display: inline-block; width: 100px; }
    select { width: 200px; }
    .stats-box {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .stat-item {
      display: inline-block;
      margin: 4px 12px 4px 0;
      padding: 6px 12px;
      background: white;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
  <script>
    let encoders = []; // 存储可用编码器列表
    
    // 页面加载时获取编码器列表
    async function loadEncoders() {
      try {
        const response = await fetch('/api/encoders');
        encoders = await response.json();
        const encoderSelect = document.getElementById('encoderName');
        encoderSelect.innerHTML = '<option value="">自动选择</option>';
        
        encoders.forEach(encoder => {
          const option = document.createElement('option');
          option.value = encoder.name;
          option.textContent = encoder.displayName;
          if (encoder.name === document.getElementById('encoderName').dataset.current) {
            option.selected = true;
          }
          encoderSelect.appendChild(option);
        });
      } catch (e) {
        console.error('Failed to load encoders:', e);
      }
    }
    
    async function refresh() {
      const s = await fetch('/api/config').then(r=>r.json())
      const rtsp = document.getElementById('rtsp')
      rtsp.textContent = s.rtsp
      rtsp.href = s.rtsp
      const web = document.getElementById('web')
      web.textContent = s.web
      web.href = s.web
      document.getElementById('deviceName').value = s.deviceName || ''
      document.getElementById('showDeviceName').checked = !!s.showDeviceName
      document.getElementById('username').value = s.username || 'admin'
      document.getElementById('password').value = s.password || ''
      document.getElementById('port').value = s.port || 18554  // 将默认端口从8554改为18554
      document.getElementById('bitrate').value = s.bitrate || 4000000
      document.getElementById('fps').value = s.fps || 30
      // 设置编码器选项
      document.getElementById('encoderName').dataset.current = s.encoderName || '';
      document.getElementById('mimeType').value = s.mimeType || 'video/avc';
      document.getElementById('pushEnabled').checked = !!s.pushEnabled
      document.getElementById('pushUrl').value = s.pushUrl || ''
      document.getElementById('pushUseRemoteConfig').checked = !!s.pushUseRemoteConfig
      document.getElementById('pushConfigUrl').value = s.pushConfigUrl || ''
      document.getElementById('audioEnabled').checked = s.audioEnabled !== false
      
      // 加载编码器列表
      await loadEncoders();
      
      const res = `${s.width}x${s.height}`
      document.getElementById('resolution').value = res
    }
    
    async function refreshStats() {
      try {
        const stats = await fetch('/api/stats').then(r=>r.json())
        document.getElementById('statFps').textContent = `帧数: ${stats.currentFps || 0} FPS`
        document.getElementById('statCpu').textContent = `CPU: ${(stats.cpuUsage || 0).toFixed(1)}%`
        document.getElementById('statNetwork').textContent = `网络: 上传 ${(stats.networkTxKbps || 0).toFixed(1)} Kbps / 下载 ${(stats.networkRxKbps || 0).toFixed(1)} Kbps`
        document.getElementById('statCpuTemp').textContent = `CPU温度: ${(stats.cpuTemp || 0).toFixed(1)}°C`
        document.getElementById('statBatteryTemp').textContent = `电池温度: ${(stats.batteryTemp || 0).toFixed(1)}°C`
        document.getElementById('statBatteryLevel').textContent = `电池电量: ${stats.batteryLevel || 0}%`
        if (stats.encoderName) {
          document.getElementById('statEncoder').textContent = `编码器: ${stats.encoderName} (${stats.width}x${stats.height} @ ${Math.floor(stats.bitrate / 1000)} Kbps)`
        } else {
          document.getElementById('statEncoder').textContent = `编码器: 未启动`
        }
      } catch (e) {
        console.error('Failed to refresh stats:', e)
      }
    }
    
    async function applyCfg() {
      const torch = document.getElementById('torch').checked
      const watermark = document.getElementById('watermark').checked
      const zoom = parseFloat(document.getElementById('zoom').value)
      const deviceName = document.getElementById('deviceName').value
      const showDeviceName = document.getElementById('showDeviceName').checked
      const username = document.getElementById('username').value
      const password = document.getElementById('password').value
      const port = parseInt(document.getElementById('port').value, 10)
      const bitrate = parseInt(document.getElementById('bitrate').value, 10)
      const fps = parseInt(document.getElementById('fps').value, 10)
      const encoderName = document.getElementById('encoderName').value || null
      const mimeType = document.getElementById('mimeType').value
      const pushEnabled = document.getElementById('pushEnabled').checked
      const pushUrl = document.getElementById('pushUrl').value
      const pushUseRemoteConfig = document.getElementById('pushUseRemoteConfig').checked
      const pushConfigUrl = document.getElementById('pushConfigUrl').value
      const audioEnabled = document.getElementById('audioEnabled').checked
      const [width, height] = document.getElementById('resolution').value.split('x').map(x=>parseInt(x,10))
      await fetch('/api/config', {method:'POST', body: JSON.stringify({torch, watermark, zoom, deviceName, showDeviceName, username, password, port, bitrate, fps, encoderName, mimeType, width, height, pushEnabled, pushUrl, pushUseRemoteConfig, pushConfigUrl, audioEnabled})})
      refresh()
    }
    
    function startPreview() {
      const img = document.getElementById('mjpeg')
      img.src = '/stream.mjpg'
    }
    
    window.onload = ()=>{ refresh(); startPreview(); setInterval(refreshStats, 1000); }
  </script>
</head>
<body>
  <h2>QNVR 预览</h2>
  <img id="mjpeg" alt="预览" />
  <div class="row">RTSP 地址：<a id="rtsp" href="#" target="_blank"></a></div>
  <div class="row">Web 地址：<a id="web" href="#" target="_blank"></a></div>
  
  <div class="stats-box">
    <h3 style="margin: 0 0 8px 0;">系统监控</h3>
    <div class="stat-item" id="statFps">帧数: -- FPS</div>
    <div class="stat-item" id="statCpu">CPU: --%</div>
    <div class="stat-item" id="statNetwork">网络: 上传 -- Kbps / 下载 -- Kbps</div>
    <div class="stat-item" id="statCpuTemp">CPU温度: --°C</div>
    <div class="stat-item" id="statBatteryTemp">电池温度: --°C</div>
    <div class="stat-item" id="statBatteryLevel">电池电量: --%</div>
    <div class="stat-item" id="statEncoder">编码器: 未启动</div>
  </div>
  
  <h3>参数配置</h3>
  <div class="row"><label>设备名</label><input id="deviceName" type="text"></div>
  <div class="row"><label>显示设备名</label><input id="showDeviceName" type="checkbox"></div>
  <div class="row"><label>用户名</label><input id="username" type="text" value="admin"></div>
  <div class="row"><label>密码</label><input id="password" type="password"></div>
  <div class="row"><label>RTSP 端口</label><input id="port" type="number" min="1024" max="65535" value="18554"></div>  <!-- 将默认端口从8554改为18554 -->
  <div class="row"><label>码率</label><input id="bitrate" type="number" min="500000" step="100000" value="4000000"></div>
  <div class="row"><label>帧率</label><input id="fps" type="number" min="1" max="60" value="30"></div>
  <div class="row"><label>编码格式</label>
    <select id="mimeType">
      <option value="video/avc">H.264/AVC</option>
      <option value="video/hevc">H.265/HEVC</option>
    </select>
  </div>
  <div class="row"><label>编码器</label><select id="encoderName"></select></div>
  <div class="row"><label>分辨率</label>
    <select id="resolution">
      <option value="1280x720">1280x720</option>
      <option value="1920x1080">1920x1080</option>
      <option value="640x480">640x480</option>
    </select>
  </div>
  <div class="row"><label>主动推流</label><input id="pushEnabled" type="checkbox"></div>
  <div class="row"><label>推流地址</label><input id="pushUrl" type="text" placeholder="rtsp://user:pass@host:port/live"></div>
  <div class="row"><label>远程配置</label><input id="pushUseRemoteConfig" type="checkbox"></div>
  <div class="row"><label>配置地址</label><input id="pushConfigUrl" type="text" placeholder="https://example.com/push.json"></div>
  <div class="row"><label>启用音频</label><input id="audioEnabled" type="checkbox" checked></div>
  <div class="row"><label>手电筒</label><input id="torch" type="checkbox"></div>
  <div class="row"><label>时间水印</label><input id="watermark" type="checkbox" checked></div>
  <div class="row"><label>变焦</label><input id="zoom" type="range" min="1" max="4" step="0.1" value="1"></div>
  <button onclick="applyCfg()">应用</button>
</body>
</html>
